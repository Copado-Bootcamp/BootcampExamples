@IsTest
private class TestMethod5 {
    
    // EXISTING METHOD - DON'T TOUCH
    @IsTest 
    static void testHighPriorityEscalation() {
        // ... existing code stays exactly as-is ...
    }
    
    // ✅ NEW METHOD 1: Empty list handling
    @IsTest 
    static void testEmptyListHandling() {
        // Covers: Lines 3-19 (early exit when empty list passed)
        Test.startTest();
        CaseUpdateHandler.updateCases(new List<Case>());
        Test.stopTest();
        
        System.assert(true, 'Empty list should be handled gracefully without errors.');
    }
    
    // ✅ NEW METHOD 2: Negative condition - NOT High Priority
    @IsTest 
    static void testNonHighPriorityNotEscalated() {
        // Covers: Negative branch of line 77 (when Priority != 'High')
        Case lowPriorityCase = new Case(
            Priority='Low', 
            Status='New', 
            Subject='Low Priority Test'
        );
        insert lowPriorityCase;
        
        Test.startTest();
        CaseUpdateHandler.updateCases(new List<Case>{lowPriorityCase});
        Test.stopTest();
        
        Case unchangedCase = [SELECT Status, IsEscalated FROM Case WHERE Id = :lowPriorityCase.Id];
        System.assertEquals('New', unchangedCase.Status, 
            'Non-high priority cases should not be escalated.');
        System.assertEquals(false, unchangedCase.IsEscalated, 
            'IsEscalated should remain false.');
    }
    
    // ✅ NEW METHOD 3: Bulk integration - all conditions simultaneously
    @IsTest 
    static void testBulkAllConditionsIntegration() {
        // Covers: All methods working together in bulk, realistic production scenario
        Account partnerAccount = new Account(Name='Bulk Partner', Type='Partner');
        Account normalAccount = new Account(Name='Bulk Normal', Type='Customer');
        insert new List<Account>{partnerAccount, normalAccount};
        
        Contact optedOutContact = new Contact(LastName='Bulk OptOut', HasOptedOutOfEmail=true);
        insert optedOutContact;
        
        Entitlement testEnt = new Entitlement(Name='Bulk Ent', AccountId=normalAccount.Id);
        insert testEnt;
        
        List<Case> bulkCases = new List<Case>{
            // Triple condition: Partner + Community + High (Methods 1, 4, 5)
            new Case(AccountId=partnerAccount.Id, Origin='Community', Priority='High', Status='New', Subject='Triple'),
            // Double condition: OptOut + High (Methods 2, 5)
            new Case(ContactId=optedOutContact.Id, Priority='High', Status='New', Description='Double', Subject='Double'),
            // Double condition: Entitlement + High (Methods 3, 5)
            new Case(AccountId=normalAccount.Id, EntitlementId=testEnt.Id, Priority='High', Status='New', Subject='Ent High', Description='Desc'),
            // Baseline: No conditions
            new Case(Priority='Low', Origin='Web', Status='New', Subject='Normal')
        };
        insert bulkCases;
        
        Test.startTest();
        CaseUpdateHandler.updateCases(bulkCases);
        Test.stopTest();
        
        Map<Id, Case> updatedCases = new Map<Id, Case>([
            SELECT Status, IsEscalated, Description, Subject, OwnerId 
            FROM Case WHERE Id IN :bulkCases
        ]);
        
        // Triple condition case
        Case triple = updatedCases.get(bulkCases[0].Id);
        System.assertEquals('Escalated', triple.Status, 'Triple condition should escalate.');
        System.assertEquals(true, triple.IsEscalated, 'Triple IsEscalated should be true.');
        System.assertNotEquals(null, triple.OwnerId, 'Queue should be assigned.');
        
        // OptOut + High case
        Case optOut = updatedCases.get(bulkCases[1].Id);
        System.assertEquals('Escalated', optOut.Status, 'High priority should escalate.');
        System.assert(optOut.Description.startsWith('Phone Call ONLY - '), 'OptOut prefix should apply.');
        
        // Entitlement + High case
        Case ent = updatedCases.get(bulkCases[2].Id);
        System.assertEquals('Escalated', ent.Status, 'Entitlement + High should escalate.');
        System.assert(ent.Subject.startsWith('Entitlement - '), 'Entitlement prefix should apply.');
        
        // Normal case
        Case normal = updatedCases.get(bulkCases[3].Id);
        System.assertEquals('New', normal.Status, 'Normal case should remain unchanged.');
        System.assertEquals(false, normal.IsEscalated, 'Normal case should not escalate.');
    }
}
